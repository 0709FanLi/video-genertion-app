# 视频生成API故障排查指南

## 🚨 错误信息

```json
{
    "detail": {
        "message": "创建任务失败",
        "detail": "{\"code\":\"InvalidParameter\",\"message\":\"Model not exist.\",\"request_id\":\"3579a474-e6c6-4b28-bade-f182d874b80a\"}"
    }
}
```

## 🔍 问题分析

### 错误含义
- **错误码**: `InvalidParameter`
- **错误信息**: `Model not exist`
- **含义**: 请求的模型不存在或无权访问

### 测试结果

我已经测试了多个模型名称：

| 模型名称 | 端点 | 结果 |
|---------|------|------|
| `wanx-v1` | text2image | ✅ 正常 |
| `wanx-i2v-v1` | video-synthesis | ❌ Model not exist |
| `cogvideox` | video-synthesis | ❌ Model not exist |
| `wanx-v1-video` | video-synthesis | ❌ Model not exist |

**结论**: 文生图API正常工作，但视频生成API无法访问任何模型。

## 🤔 可能的原因

### 原因1：API密钥权限不足 ⭐⭐⭐⭐⭐ （最可能）

**现象**:
- 文生图功能正常
- 视频生成功能报错 "Model not exist"

**原因**:
阿里云DashScope的不同功能需要不同的权限。视频生成功能通常需要：
- 单独开通服务
- 更高级别的API密钥
- 付费订阅

**如何确认**:
1. 登录阿里云控制台：https://dashscope.console.aliyun.com
2. 查看 **API-KEY管理**
3. 点击您的API密钥，查看 **权限范围**
4. 确认是否包含 **视频生成** 或 **通义万相-视频生成**

**解决方法**:
1. 在控制台申请开通视频生成服务
2. 或创建新的API密钥，勾选视频生成权限
3. 可能需要充值或订阅相应套餐

### 原因2：模型已下线或更名 ⭐⭐⭐

**现象**:
所有已知的视频生成模型名称都返回不存在

**原因**:
阿里云可能：
- 更新了模型命名规则
- 下线了旧版本模型
- 推出了新的视频生成服务

**如何确认**:
1. 访问官方文档：https://help.aliyun.com/zh/dashscope/
2. 搜索 **视频生成** 或 **图生视频**
3. 查看最新的API文档和模型列表

**解决方法**:
1. 查找官方文档中的最新模型名称
2. 更新代码中的模型名称
3. 按照最新文档调整API参数

### 原因3：服务未开通 ⭐⭐⭐⭐

**现象**:
即使API密钥有效，仍然无法访问视频生成功能

**原因**:
视频生成服务可能需要：
- 在控制台单独开通
- 完成实名认证
- 接受服务条款
- 账户有足够余额

**如何确认**:
1. 登录阿里云控制台
2. 进入 **DashScope** 产品页
3. 查看 **通义万相** 服务状态
4. 确认是否显示 **已开通** 或 **未开通**

**解决方法**:
1. 点击 **开通服务**
2. 完成必要的认证流程
3. 根据需要充值或购买资源包

### 原因4：区域或网络问题 ⭐

**现象**:
部分用户可能因地理位置或网络限制无法访问某些服务

**原因**:
- 服务仅在特定区域可用
- 网络防火墙阻止
- DNS解析问题

**如何确认**:
1. 尝试从不同网络环境访问
2. 检查是否有防火墙或代理设置
3. 确认您的账号区域设置

## 🔧 详细排查步骤

### 步骤1：登录阿里云控制台

1. 访问：https://dashscope.console.aliyun.com
2. 使用您的阿里云账号登录

### 步骤2：检查服务开通状态

在控制台中查找：
- **通义万相** 服务
- **视频生成** 功能
- 服务状态是否为 **已开通**

如果未开通：
1. 点击 **立即开通**
2. 阅读并同意服务协议
3. 完成开通流程

### 步骤3：检查API密钥权限

1. 进入 **API-KEY管理** 页面
2. 找到您使用的API密钥（开头为 `sk-8b6db592...`）
3. 查看 **权限范围** 或 **服务范围**
4. 确认是否包含：
   - ✅ 通义万相-文生图
   - ❓ 通义万相-图生视频
   - ❓ 通义万相-视频生成

如果没有视频生成权限：
1. 点击 **编辑权限**
2. 勾选视频生成相关服务
3. 保存并等待生效（通常几分钟）

### 步骤4：查找正确的模型名称

1. 在控制台查找 **API文档** 或 **开发指南**
2. 搜索 **视频生成** 或 **图生视频**
3. 找到 **模型列表** 部分
4. 记录当前可用的模型名称

可能的模型名称（需要确认）：
- `wanx-v2` (新版本？)
- `cogvideo-v1.5` (CogVideo系列？)
- `video-generation-v1` (通用名称？)
- 其他文档中提到的名称

### 步骤5：测试API

使用curl命令测试（替换为正确的模型名称）：

```bash
curl -X POST "https://dashscope.aliyuncs.com/api/v1/services/aigc/video-generation/video-synthesis" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -H "X-DashScope-Async: enable" \
  -d '{
    "model": "正确的模型名称",
    "input": {
      "prompt": "test video generation"
    }
  }'
```

成功响应示例：
```json
{
  "request_id": "xxx",
  "output": {
    "task_id": "xxx",
    "task_status": "PENDING"
  }
}
```

### 步骤6：更新代码

如果找到了正确的模型名称，更新以下文件：

**文件**: `backend/app/services/wanx_service.py`

```python
# 第237行左右
payload = {
    "model": "正确的模型名称",  # 更新这里
    "input": {
        "prompt": prompt,
        "img_url": image_url
    }
}
```

**文件**: `backend/main.py` (旧版本)

```python
# 第137行左右
payload = {
    "model": "正确的模型名称",  # 更新这里
    "input": {
        "prompt": request.prompt,
        "img_url": request.image_url
    }
}
```

## 📞 联系阿里云技术支持

如果以上步骤都无法解决问题，建议联系阿里云技术支持：

### 提供的信息

1. **Request ID**: `3579a474-e6c6-4b28-bade-f182d874b80a`
2. **API密钥**（前几位）: `sk-8b6db592...`
3. **错误信息**:
   ```
   Code: InvalidParameter
   Message: Model not exist
   ```
4. **问题描述**:
   - 文生图功能正常
   - 视频生成功能报错模型不存在
   - 已尝试的模型名称：wanx-i2v-v1, cogvideox等

### 联系方式

- **工单系统**: 阿里云控制台 → 工单中心
- **在线客服**: 阿里云控制台右下角
- **电话支持**: 查看阿里云官网的联系方式

### 建议询问的问题

1. 视频生成功能是否需要单独开通？
2. 当前可用的视频生成模型名称是什么？
3. 我的API密钥是否有视频生成权限？
4. 是否需要升级套餐或充值？
5. 视频生成服务的收费标准是什么？

## 🔄 临时替代方案

在等待问题解决期间，您可以：

### 方案1：仅使用文生图功能

保持前3步正常工作：
1. ✅ 输入想法 → 生成提示词
2. ✅ 选择提示词 → 生成图片
3. ✅ 选择图片 → 下载保存

然后使用其他工具生成视频：
- Runway (https://runwayml.com)
- Pika (https://pika.art)
- 其他图生视频工具

### 方案2：使用其他AI服务

如果阿里云的视频生成服务暂时不可用，可以考虑：
- **OpenAI Sora** (如果有访问权限)
- **Stability AI** 的视频生成服务
- **本地部署** CogVideo 模型

### 方案3：分阶段实现

1. **第一阶段**: 完善文生图功能（已实现）
2. **第二阶段**: 等待视频生成API可用
3. **第三阶段**: 集成视频生成功能

## 📊 成本考虑

视频生成功能通常比文生图贵得多：

| 功能 | 大约成本 |
|------|---------|
| 文生图 | ￥0.1-0.5/张 |
| 图生视频 | ￥1-10/视频 |

**建议**:
1. 先确认定价
2. 设置每日预算上限
3. 在测试期间谨慎使用

## ✅ 成功标志

当问题解决后，您应该看到：

```json
{
  "request_id": "xxx",
  "output": {
    "task_id": "abc123",
    "task_status": "PENDING"
  }
}
```

而不是：
```json
{
  "code": "InvalidParameter",
  "message": "Model not exist"
}
```

## 📚 相关文档

- **阿里云DashScope**: https://dashscope.console.aliyun.com
- **API文档**: https://help.aliyun.com/zh/dashscope/
- **价格说明**: 控制台中的计费中心
- **工单系统**: 控制台 → 支持与服务 → 工单管理

## 🔔 下一步

1. ✅ 先按照步骤1-3检查权限和服务状态
2. ✅ 查找官方文档中的正确模型名称
3. ✅ 如果仍无法解决，提交工单给阿里云
4. ✅ 等待回复期间，可以继续使用文生图功能

---

**文档版本**: 1.0  
**创建时间**: 2025-10-24  
**适用项目**: AI视频创作工作流系统

## 📝 更新记录

### ✅ 问题已解决 (2025-10-24)

- **问题原因**: 模型名称已更新，旧版本 `wanx-i2v-v1` 已下线
- **解决方法**: 更新为新模型 `wan2.5-i2v-preview`
- **正确的模型名称**: `wan2.5-i2v-preview`
- **所需权限**: 需要开通通义万相视频生成服务
- **其他注意事项**: 
  - 这是Preview预览版本
  - 代码已更新到新模型
  - 需要重启后端服务使更改生效

