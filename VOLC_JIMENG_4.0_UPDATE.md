# ç«å±±å¼•æ“å³æ¢¦4.0 APIé›†æˆæ›´æ–°æ–‡æ¡£

## ğŸ“‹ æ›´æ–°æ—¶é—´
2025-10-28

## ğŸ¯ æ›´æ–°ç›®çš„
æ ¹æ®ç«å±±å¼•æ“å³æ¢¦4.0å®˜æ–¹æ–‡æ¡£ï¼ˆhttps://www.volcengine.com/docs/85621/1817045ï¼‰ï¼Œä¿®å¤å¹¶å‡çº§APIé›†æˆï¼Œå®ç°å®Œæ•´çš„å›¾ç”Ÿå›¾åŠŸèƒ½ã€‚

---

## ğŸ” å…³é”®å‘ç°

### 1. **å‚è€ƒå›¾å‚æ•°åç§°é”™è¯¯**

**ä¹‹å‰çš„é”™è¯¯å®ç°**ï¼š
```python
# âŒ é”™è¯¯ï¼šä½¿ç”¨äº†ä¸å­˜åœ¨çš„å‚æ•°å
if reference_image_url:
    body_dict["ref_img"] = reference_image_url  # é”™è¯¯çš„å‚æ•°å
```

**æ­£ç¡®çš„å®ç°**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨å®˜æ–¹æ–‡æ¡£çš„å‚æ•°å
if reference_image_urls and len(reference_image_urls) > 0:
    body_dict["image_urls"] = reference_image_urls[:10]  # æ­£ç¡®çš„å‚æ•°åï¼Œæ”¯æŒæ•°ç»„
```

### 2. **APIè°ƒç”¨æ¨¡å¼å˜æ›´**

**ä¹‹å‰**: ä½¿ç”¨åŒæ­¥APIï¼ˆ`CVProcess`ï¼‰
**ç°åœ¨**: ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡æ¨¡å¼ï¼ˆ`CVSync2AsyncSubmitTask` + `CVSync2AsyncGetResult`ï¼‰

### 3. **æ¨¡å‹æ ‡è¯†æ›´æ–°**

**ä¹‹å‰**: `req_key = "general_v2.0"`
**ç°åœ¨**: `req_key = "jimeng_t2i_v40"`

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `/backend/app/services/volc_jimeng_service.py`

#### å˜æ›´å†…å®¹ï¼š

1. **æ·»åŠ  `asyncio` å¯¼å…¥**
   ```python
   import asyncio
   ```

2. **ä¿®æ”¹ `generate_image` æ–¹æ³•ç­¾å**
   ```python
   async def generate_image(
       self,
       prompt: str,
       model: str = "jimeng_t2i_v40",  # æ›´æ–°é»˜è®¤æ¨¡å‹
       size: str = "1024x1024",
       num_images: int = 1,
       reference_image_urls: Optional[List[str]] = None,  # æ”¹ä¸ºåˆ—è¡¨
       **kwargs: Any
   ) -> List[str]:
   ```

3. **å®ç°å¼‚æ­¥ä»»åŠ¡æ¨¡å¼**
   - **æ­¥éª¤1**: æäº¤ä»»åŠ¡è·å– `task_id`
   - **æ­¥éª¤2**: è½®è¯¢æŸ¥è¯¢ç»“æœï¼ˆæœ€å¤š30æ¬¡ï¼Œæ¯æ¬¡é—´éš”2ç§’ï¼‰

4. **ä¿®å¤å‚è€ƒå›¾å‚æ•°**
   ```python
   # æ­£ç¡®ä½¿ç”¨ image_urls å‚æ•°
   if reference_image_urls and len(reference_image_urls) > 0:
       body_dict["image_urls"] = reference_image_urls[:10]  # æ”¯æŒ0-10å¼ 
   ```

5. **æ›´æ–° req_key**
   ```python
   body_dict = {
       "req_key": "jimeng_t2i_v40",  # å³æ¢¦4.0æ ‡è¯†
       "prompt": prompt,
       "force_single": num_images == 1,
   }
   ```

---

### 2. `/backend/app/core/config.py`

#### å˜æ›´å†…å®¹ï¼š

```python
text_to_image_models: dict = {
    "volc-jimeng": {
        "name": "ç«å±±å¼•æ“å³æ¢¦4.0",          # æ›´æ–°åç§°
        "model_id": "jimeng_t2i_v40",       # æ›´æ–°æ¨¡å‹ID
        "default": True,
        "supports_reference": True,
        "max_reference_images": 10          # ä»1å¼ å¢åŠ åˆ°10å¼ ï¼ˆå»ºè®®6å¼ ä»¥å†…ï¼‰
    },
    # ... å…¶ä»–æ¨¡å‹
}
```

---

### 3. `/backend/app/api/routes/text_to_image.py`

#### å˜æ›´å†…å®¹ï¼š

```python
if request.model == "volc-jimeng":
    # ç«å±±å¼•æ“å³æ¢¦4.0ï¼ˆæ”¯æŒæœ€å¤š10å¼ å‚è€ƒå›¾ï¼Œå»ºè®®6å¼ ä»¥å†…ï¼‰
    image_urls = await volc_jimeng_service.generate_image(
        prompt=request.prompt,
        size=request.size,
        num_images=request.num_images,
        reference_image_urls=request.reference_image_urls  # ç›´æ¥ä¼ é€’å®Œæ•´åˆ—è¡¨
    )
```

**ç§»é™¤äº†ä¹‹å‰çš„é”™è¯¯é€»è¾‘**ï¼š
```python
# âŒ åˆ é™¤ï¼šä¸å†éœ€è¦æ‰‹åŠ¨æå–ç¬¬ä¸€å¼ å›¾ç‰‡
# ref_img_url = None
# if request.reference_image_urls and len(request.reference_image_urls) > 0:
#     ref_img_url = request.reference_image_urls[0]
```

---

## ğŸ¯ æ ¸å¿ƒAPIå‚æ•°å¯¹ç…§è¡¨

| å‚æ•°å | ç±»å‹ | å¿…é€‰ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| `req_key` | string | âœ… | - | å›ºå®šå€¼ï¼š`jimeng_t2i_v40` |
| `image_urls` | array of string | âŒ | [] | **å‚è€ƒå›¾URLæ•°ç»„**ï¼ˆ0-10å¼ ï¼Œå»ºè®®â‰¤6å¼ ï¼‰ |
| `prompt` | string | âœ… | - | æç¤ºè¯ï¼ˆæœ€é•¿800å­—ç¬¦ï¼‰ |
| `size` | int | âŒ | 4194304 | å›¾ç‰‡é¢ç§¯ï¼ˆé»˜è®¤2Kåˆ†è¾¨ç‡ï¼‰ |
| `width` | int | âŒ | - | å›¾ç‰‡å®½åº¦ï¼ˆéœ€åŒæ—¶ä¼ heightï¼‰ |
| `height` | int | âŒ | - | å›¾ç‰‡é«˜åº¦ï¼ˆéœ€åŒæ—¶ä¼ widthï¼‰ |
| `scale` | float | âŒ | 0.5 | æ–‡æœ¬å½±å“ç¨‹åº¦ï¼ˆ0-1ï¼‰ |
| `force_single` | bool | âŒ | false | æ˜¯å¦å¼ºåˆ¶ç”Ÿæˆå•å›¾ |
| `min_ratio` | float | âŒ | 1/3 | æœ€å°å®½é«˜æ¯” |
| `max_ratio` | float | âŒ | 3 | æœ€å¤§å®½é«˜æ¯” |

---

## ğŸ“Š å‚è€ƒå›¾é™åˆ¶æ¡ä»¶

| é¡¹ç›® | é™åˆ¶ |
|------|------|
| **å›¾ç‰‡æ ¼å¼** | ä»…æ”¯æŒJPEGã€PNGæ ¼å¼ï¼ˆå»ºè®®JPEGï¼‰ |
| **æ–‡ä»¶å¤§å°** | æœ€å¤§ 15MB |
| **åˆ†è¾¨ç‡** | æœ€å¤§ 4096 x 4096 |
| **å®½é«˜æ¯”** | ï¼ˆå®½/é«˜ï¼‰èŒƒå›´ï¼š[1/3, 3] |
| **æ•°é‡** | æœ€å¤š10å¼ ï¼Œå»ºè®®6å¼ ä»¥å†… |
| **å½±å“** | å›¾ç‰‡è¶Šå¤šï¼Œå¤„ç†æ—¶é—´è¶Šé•¿ï¼Œå‚è€ƒæ•ˆæœå¯èƒ½é™ä½ |

---

## ğŸ”„ å¼‚æ­¥ä»»åŠ¡æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æäº¤ä»»åŠ¡                                              â”‚
â”‚    POST https://visual.volcengineapi.com                 â”‚
â”‚    ?Action=CVSync2AsyncSubmitTask&Version=2022-08-31     â”‚
â”‚                                                          â”‚
â”‚    Request Body:                                         â”‚
â”‚    {                                                     â”‚
â”‚      "req_key": "jimeng_t2i_v40",                       â”‚
â”‚      "image_urls": ["https://xxx", ...],                â”‚
â”‚      "prompt": "...",                                    â”‚
â”‚      "force_single": true/false                         â”‚
â”‚    }                                                     â”‚
â”‚                                                          â”‚
â”‚    Response:                                             â”‚
â”‚    {                                                     â”‚
â”‚      "code": 10000,                                     â”‚
â”‚      "data": {                                          â”‚
â”‚        "task_id": "7392616336519610409"                â”‚
â”‚      }                                                   â”‚
â”‚    }                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è½®è¯¢æŸ¥è¯¢ç»“æœï¼ˆæ¯2ç§’ä¸€æ¬¡ï¼Œæœ€å¤š30æ¬¡ = 60ç§’ï¼‰            â”‚
â”‚    POST https://visual.volcengineapi.com                 â”‚
â”‚    ?Action=CVSync2AsyncGetResult&Version=2022-08-31      â”‚
â”‚                                                          â”‚
â”‚    Request Body:                                         â”‚
â”‚    {                                                     â”‚
â”‚      "req_key": "jimeng_t2i_v40",                       â”‚
â”‚      "task_id": "7392616336519610409",                  â”‚
â”‚      "req_json": "{\"return_url\": true}"               â”‚
â”‚    }                                                     â”‚
â”‚                                                          â”‚
â”‚    Response (è¿›è¡Œä¸­):                                     â”‚
â”‚    {                                                     â”‚
â”‚      "data": {                                          â”‚
â”‚        "status": "in_queue" | "generating"              â”‚
â”‚      }                                                   â”‚
â”‚    }                                                     â”‚
â”‚                                                          â”‚
â”‚    Response (å®Œæˆ):                                       â”‚
â”‚    {                                                     â”‚
â”‚      "code": 10000,                                     â”‚
â”‚      "data": {                                          â”‚
â”‚        "status": "done",                                â”‚
â”‚        "image_urls": ["https://xxx", ...]              â”‚
â”‚      }                                                   â”‚
â”‚    }                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… æµ‹è¯•éªŒè¯

### 1. æ–‡ç”Ÿå›¾ï¼ˆæ— å‚è€ƒå›¾ï¼‰
```bash
curl -X POST http://localhost:8000/api/text-to-image/generate \
  -H "Content-Type: application/json" \
  -d '{
    "model": "volc-jimeng",
    "prompt": "ä¸€åªå¯çˆ±çš„çŒ«å’ªåœ¨è‰åœ°ä¸Šç©è€",
    "num_images": 1,
    "size": "1024x1024"
  }'
```

### 2. å›¾ç”Ÿå›¾ï¼ˆå•å¼ å‚è€ƒå›¾ï¼‰
```bash
curl -X POST http://localhost:8000/api/text-to-image/generate \
  -H "Content-Type: application/json" \
  -d '{
    "model": "volc-jimeng",
    "prompt": "å°†èƒŒæ™¯æ¢æˆæ¼”å”±ä¼šç°åœº",
    "num_images": 1,
    "size": "1024x1024",
    "reference_image_urls": ["https://example.com/image.jpg"]
  }'
```

### 3. å¤šå›¾ç”Ÿå›¾ï¼ˆå¤šå¼ å‚è€ƒå›¾ï¼‰
```bash
curl -X POST http://localhost:8000/api/text-to-image/generate \
  -H "Content-Type: application/json" \
  -d '{
    "model": "volc-jimeng",
    "prompt": "å°†è¿™äº›ç…§ç‰‡åˆæˆä¸€å¼ æµ·æŠ¥",
    "num_images": 1,
    "size": "2048x2048",
    "reference_image_urls": [
      "https://example.com/image1.jpg",
      "https://example.com/image2.jpg",
      "https://example.com/image3.jpg"
    ]
  }'
```

---

## ğŸ› å·²ä¿®å¤çš„é—®é¢˜

1. âœ… **å‚è€ƒå›¾å‚æ•°åé”™è¯¯** - ä» `ref_img` æ”¹ä¸º `image_urls`
2. âœ… **å‚æ•°ç±»å‹é”™è¯¯** - ä»å­—ç¬¦ä¸²æ”¹ä¸ºæ•°ç»„
3. âœ… **æ¨¡å‹æ ‡è¯†è¿‡æ—¶** - ä» `general_v2.0` æ”¹ä¸º `jimeng_t2i_v40`
4. âœ… **APIè°ƒç”¨æ¨¡å¼é”™è¯¯** - ä»åŒæ­¥æ”¹ä¸ºå¼‚æ­¥ä»»åŠ¡æ¨¡å¼
5. âœ… **å‚è€ƒå›¾æ•°é‡é™åˆ¶** - ä»1å¼ æ‰©å±•åˆ°10å¼ ï¼ˆå»ºè®®6å¼ ï¼‰
6. âœ… **ç¼ºå°‘è½®è¯¢æœºåˆ¶** - æ·»åŠ å¼‚æ­¥ä»»åŠ¡çŠ¶æ€è½®è¯¢
7. âœ… **ç¼ºå°‘è¶…æ—¶å¤„ç†** - æ·»åŠ æœ€å¤š30æ¬¡è½®è¯¢è¶…æ—¶

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- **å®˜æ–¹æ–‡æ¡£**: https://www.volcengine.com/docs/85621/1817045
- **APIç­¾å**: https://www.volcengine.com/docs/6348/69869
- **é”™è¯¯ç **: æ–‡æ¡£ä¸­çš„"ä¸šåŠ¡é”™è¯¯ç "ç« èŠ‚

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¼‚æ­¥ä»»åŠ¡è€—æ—¶**: æ ¹æ®å›¾ç‰‡æ•°é‡å’Œåˆ†è¾¨ç‡ï¼Œç”Ÿæˆæ—¶é—´å¯èƒ½è¾ƒé•¿ï¼ˆ2-60ç§’ï¼‰
2. **è®¡è´¹è§„åˆ™**: æ ¹æ®è¾“å‡ºå›¾ç‰‡å¼ æ•°è®¡è´¹ï¼Œé»˜è®¤æ ¹æ®promptåˆ¤æ–­è¾“å‡ºæ•°é‡
3. **æ€§èƒ½ä¼˜åŒ–**: å¦‚æœå¯¹å»¶è¿Ÿå’Œä»·æ ¼æ•æ„Ÿï¼Œå»ºè®®ä½¿ç”¨ `force_single=true` å¼ºåˆ¶è¾“å‡ºå•å›¾
4. **å‚è€ƒå›¾æ•ˆæœ**: è¾“å…¥å›¾ç‰‡å»ºè®®æ§åˆ¶åœ¨6å¼ ä»¥å†…ï¼Œè¿‡å¤šä¼šé™ä½å‚è€ƒæ•ˆæœ
5. **URLæœ‰æ•ˆæœŸ**: è¿”å›çš„å›¾ç‰‡URLæœ‰æ•ˆæœŸä¸º24å°æ—¶

---

## ğŸ‰ æ›´æ–°æ€»ç»“

é€šè¿‡æœ¬æ¬¡æ›´æ–°ï¼š
- âœ… ä¿®å¤äº†å‚è€ƒå›¾å‚æ•°åé”™è¯¯
- âœ… å‡çº§åˆ°å³æ¢¦4.0 API
- âœ… æ”¯æŒå¤šå›¾å‚è€ƒï¼ˆæœ€å¤š10å¼ ï¼‰
- âœ… å®ç°å¼‚æ­¥ä»»åŠ¡è½®è¯¢
- âœ… æ·»åŠ å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… éµå¾ªå®˜æ–¹æ–‡æ¡£è§„èŒƒ

ç°åœ¨ç«å±±å¼•æ“å³æ¢¦4.0çš„å›¾ç”Ÿå›¾åŠŸèƒ½å·²å®Œå…¨é›†æˆï¼ğŸš€

